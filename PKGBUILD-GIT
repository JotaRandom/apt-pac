# Maintainer: Your Name <user@archlinux.org>

pkgname=apt-pac-git
_pkgname=apt-pac
pkgver=2026.01.20.r75.575f238
pkgrel=1
pkgdesc="An APT-style wrapper for pacman with APT-like output"
arch=('any')
url="https://github.com/JotaRandom/apt-pac"
license=('MIT')
depends=('python'
         'python-rich'
         'pyalpm'
         'python-tomli'
         'devtools'
         'pacman-contrib')
makedepends=('python-build'
             'python-installer'
             'python-setuptools'
             'python-wheel'
             'git')
optdepends=('man: For apt help command to display package manpages')
source=("$_pkgname::git+https://github.com/JotaRandom/$_pkgname.git")
sha256sums=('SKIP')

pkgver() {
  cd "$srcdir/$_pkgname"
  # Use the date from pyproject.toml logic (YYYY.MM.DD) + revision
  # We can't rely on the script haven run yet for the first pkgver() check, but we can rely on git tags OR just date.
  # Let's use date based versioning to match __init__.py
  printf "%s.r%s.%s" "$(date +%Y.%m.%d)" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "$srcdir/$_pkgname"
  # Update pyproject.toml to match build date
  echo "Updating version in pyproject.toml..."
  chmod +x scripts/update-version.sh
  ./scripts/update-version.sh
}

build() {
  cd "$srcdir/$_pkgname"
  python -m build --wheel --no-isolation
}

package() {
  cd "$srcdir/$_pkgname"
  python -m installer --destdir="$pkgdir" dist/*.whl
  
  # Install global configuration
  install -Dm644 config.toml "$pkgdir/etc/apt-pac/config.toml"

  # Install manpage
  install -Dm644 src/man/apt-pac.8 "$pkgdir/usr/share/man/man8/apt-pac.8"

  # Install translations
  for mo_file in locales/*.mo; do
    if [ -f "$mo_file" ]; then
      locale=$(basename "$mo_file" .mo)
      install -Dm644 "$mo_file" "$pkgdir/usr/share/locale/$locale/LC_MESSAGES/apt-pac.mo"
    fi
  done

  # Install shell completions
  install -Dm644 src/completions/apt-pac.bash "$pkgdir/usr/share/bash-completion/completions/apt-pac"
  install -Dm644 src/completions/_apt-pac "$pkgdir/usr/share/zsh/site-functions/_apt-pac"
  install -Dm644 src/completions/apt-pac.fish "$pkgdir/usr/share/fish/vendor_completions.d/apt-pac.fish"
}
